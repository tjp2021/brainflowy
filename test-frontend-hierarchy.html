<!DOCTYPE html>
<html>
<head>
    <title>Test Hierarchy Loading</title>
</head>
<body>
    <h1>Frontend Hierarchy Test</h1>
    <div id="output"></div>
    
    <script>
        async function testHierarchy() {
            const output = document.getElementById('output');
            
            // Register user
            const timestamp = Date.now();
            const email = `test_${timestamp}@example.com`;
            const password = 'TestPass123!';
            
            const registerRes = await fetch('http://localhost:8001/api/v1/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, displayName: 'Test' })
            });
            
            const { accessToken, user } = await registerRes.json();
            
            // Create outline
            const outlineRes = await fetch('http://localhost:8001/api/v1/outlines', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ title: 'Test', userId: user.id })
            });
            
            const outline = await outlineRes.json();
            
            // Create hierarchy
            const main = await fetch(`http://localhost:8001/api/v1/outlines/${outline.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ content: 'MAIN', parentId: null, style: 'normal' })
            }).then(r => r.json());
            
            const sub1 = await fetch(`http://localhost:8001/api/v1/outlines/${outline.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ content: 'SUB1', parentId: main.id, style: 'normal' })
            }).then(r => r.json());
            
            const subsub = await fetch(`http://localhost:8001/api/v1/outlines/${outline.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({ content: 'SUBSUB', parentId: sub1.id, style: 'normal' })
            }).then(r => r.json());
            
            // Get items back
            const itemsRes = await fetch(`http://localhost:8001/api/v1/outlines/${outline.id}/items`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            
            const items = await itemsRes.json();
            
            output.innerHTML = '<h2>Raw API Response:</h2><pre>' + JSON.stringify(items, null, 2) + '</pre>';
            
            // Now simulate frontend conversion
            const convertItems = (items, level = 0) => {
                return items.map(item => ({
                    ...item,
                    text: item.content || item.text || '',
                    level: level,
                    expanded: true,
                    children: item.children ? convertItems(item.children, level + 1) : []
                }));
            };
            
            const converted = convertItems(items);
            
            output.innerHTML += '<h2>After Frontend Conversion:</h2><pre>' + JSON.stringify(converted, null, 2) + '</pre>';
            
            // Flatten for display
            const flatten = (items, result = []) => {
                items.forEach(item => {
                    result.push(item);
                    if (item.expanded && item.children && item.children.length > 0) {
                        flatten(item.children, result);
                    }
                });
                return result;
            };
            
            const flat = flatten(converted);
            
            output.innerHTML += '<h2>Flattened for Display:</h2>';
            flat.forEach(item => {
                const padding = (item.level || 0) * 24;
                output.innerHTML += `<div style="padding-left: ${padding}px">â€¢ ${item.text} (level: ${item.level})</div>`;
            });
        }
        
        testHierarchy().catch(err => {
            document.getElementById('output').innerHTML = 'Error: ' + err.message;
        });
    </script>
</body>
</html>